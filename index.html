import React, { useState, useEffect, useMemo } from 'react';
import { 
  Plus, Trash2, CheckCircle2, RotateCcw, Calendar, 
  Repeat, Target, Trophy, Flame, AlertCircle, 
  X, Quote, Share2, Copy, MapPin, Sparkles,
  TrendingUp, Award, Camera, Info, Check
} from 'lucide-react';

const apiKey = ""; // Provided at runtime

// Expanded Library of Historical Figures
const CELEBRATION_DATA = [
  { id: "ma-01", name: "Marcus Aurelius", quote: "Very little is needed to make a happy life; it is all within yourself.", image: "https://images.unsplash.com/photo-1599707334386-611932926a44?auto=format&fit=crop&q=80&w=800", bio: "Roman Emperor" },
  { id: "ae-02", name: "Amelia Earhart", quote: "The most difficult thing is the decision to act, the rest is merely tenacity.", image: "https://images.unsplash.com/photo-1517976487492-5750f3195933?auto=format&fit=crop&q=80&w=800", bio: "Aviation Pioneer" },
  { id: "mg-03", name: "Mahatma Gandhi", quote: "The future depends on what you do today.", image: "https://images.unsplash.com/photo-1589829085413-56de8ae18c73?auto=format&fit=crop&q=80&w=800", bio: "Civil Rights Leader" },
  { id: "mc-04", name: "Marie Curie", quote: "Now is the time to understand more, so that we may fear less.", image: "https://images.unsplash.com/photo-1532187863486-abf9d39d99c5?auto=format&fit=crop&q=80&w=800", bio: "Physicist" },
  { id: "nm-05", name: "Nelson Mandela", quote: "It always seems impossible until it's done.", image: "https://images.unsplash.com/photo-1548013146-72479768b921?auto=format&fit=crop&q=80&w=800", bio: "Former President of SA" },
  { id: "tr-06", name: "Theodore Roosevelt", quote: "Believe you can and you're halfway there.", image: "https://images.unsplash.com/photo-1585076800246-44362df50abb?auto=format&fit=crop&q=80&w=800", bio: "26th US President" },
  { id: "st-07", name: "Sojourner Truth", quote: "Truth is powerful and it prevails.", image: "https://images.unsplash.com/photo-1501504905252-473c47e087f8?auto=format&fit=crop&q=80&w=800", bio: "Abolitionist" },
  { id: "ae-08", name: "Albert Einstein", quote: "Life is like riding a bicycle. To keep your balance, you must keep moving.", image: "https://images.unsplash.com/photo-1583511655857-d19b40a7a54e?auto=format&fit=crop&q=80&w=800", bio: "Theoretical Physicist" },
  { id: "mlk-10", name: "Martin Luther King Jr.", quote: "The time is always right to do what is right.", image: "https://images.unsplash.com/photo-1569429593440-ed46555c9391?auto=format&fit=crop&q=80&w=800", bio: "Civil Rights Leader" },
  { id: "wc-13", name: "Winston Churchill", quote: "Success is not final, failure is not fatal: it is the courage to continue.", image: "https://images.unsplash.com/photo-1513151233558-d860c5398176?auto=format&fit=crop&q=80&w=800", bio: "UK Prime Minister" }
];

const App = () => {
  // State Initialization
  const [resolutions, setResolutions] = useState(() => {
    try {
      const saved = localStorage.getItem('dbq_resolutions_v2');
      return saved ? JSON.parse(saved) : [];
    } catch (e) { return []; }
  });

  const [seenQuoteIds, setSeenQuoteIds] = useState(() => {
    try {
      const saved = localStorage.getItem('dbq_seen_quotes_v2');
      return saved ? JSON.parse(saved) : [];
    } catch (e) { return []; }
  });

  const [inputText, setInputText] = useState('');
  const [inputType, setInputType] = useState('daily');
  const [filter, setFilter] = useState('all');
  const [error, setError] = useState('');
  const [celebration, setCelebration] = useState(null);
  const [imgLoaded, setImgLoaded] = useState(false);
  const [showShareModal, setShowShareModal] = useState(false);
  const [isGenerating, setIsGenerating] = useState(false);
  const [shareImage, setShareImage] = useState(null);
  const [shareCaption, setShareCaption] = useState('');

  // Persistence
  useEffect(() => {
    localStorage.setItem('dbq_resolutions_v2', JSON.stringify(resolutions));
  }, [resolutions]);

  useEffect(() => {
    localStorage.setItem('dbq_seen_quotes_v2', JSON.stringify(seenQuoteIds));
  }, [seenQuoteIds]);

  // Derived Stats
  const stats = useMemo(() => {
    const total = resolutions.length;
    const completedAnnual = resolutions.filter(r => r.type === 'annual' && r.isCompleted).length;
    const totalTicks = resolutions.filter(r => r.type !== 'annual').reduce((acc, curr) => acc + (curr.count || 0), 0);
    return { total, completedAnnual, totalTicks };
  }, [resolutions]);

  // Handlers
  const addResolution = (e) => {
    e.preventDefault();
    if (!inputText.trim()) {
      setError('Enter a goal to begin!');
      return;
    }
    const newRes = {
      id: Math.random().toString(36).substr(2, 9),
      text: inputText.trim(),
      type: inputType,
      count: 0,
      isCompleted: false,
      createdAt: new Date().toISOString()
    };
    setResolutions([newRes, ...resolutions]);
    setInputText('');
    setError('');
  };

  const handleAction = (id) => {
    let triggered = false;
    setResolutions(prev => prev.map(res => {
      if (res.id === id) {
        if (res.type === 'annual') {
          if (!res.isCompleted) triggered = true;
          return { ...res, isCompleted: !res.isCompleted };
        } else {
          triggered = true;
          return { ...res, count: (res.count || 0) + 1 };
        }
      }
      return res;
    }));
    if (triggered) triggerCelebration();
  };

  const triggerCelebration = () => {
    let pool = CELEBRATION_DATA.filter(q => !seenQuoteIds.includes(q.id));
    if (pool.length === 0) {
      pool = CELEBRATION_DATA;
      setSeenQuoteIds([]);
    }
    const quote = pool[Math.floor(Math.random() * pool.length)];
    setSeenQuoteIds(prev => [...prev, quote.id]);
    setImgLoaded(false);
    setCelebration(quote);
  };

  const deleteRes = (id) => setResolutions(resolutions.filter(r => r.id !== id));

  // AI Sharing Logic
  const generateShare = async () => {
    setIsGenerating(true);
    setShowShareModal(true);
    
    const fetchWithRetry = async (url, options) => {
      for (let i = 0; i < 5; i++) {
        try {
          const res = await fetch(url, options);
          if (res.ok) return await res.json();
        } catch (e) {}
        await new Promise(r => setTimeout(r, 1000 * Math.pow(2, i)));
      }
    };

    try {
      // Caption
      const capResult = await fetchWithRetry(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            contents: [{ parts: [{ text: `Create a punchy Instagram Story caption for a Dubuque, Iowa resident tracking ${stats.total} resolutions. They have ${stats.totalTicks} habit completions. Include tags like #Dubuque #563 #KeyCity #Iowa. Keep it under 150 characters.` }] }] 
          })
        }
      );
      setShareCaption(capResult.candidates[0].content.parts[0].text);

      // Image
      const imgResult = await fetchWithRetry(
        `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            instances: { prompt: "Minimalist aesthetic Instagram Story background with subtle architectural silhouette of the Julien Dubuque bridge, sunrise over the Mississippi river, soft golden hour colors, professional graphic design style, plenty of negative space for text." },
            parameters: { sampleCount: 1 }
          })
        }
      );
      if (imgResult?.predictions?.[0]?.bytesBase64Encoded) {
        setShareImage(`data:image/png;base64,${imgResult.predictions[0].bytesBase64Encoded}`);
      }
    } catch (e) {
      setError("AI generation paused. Please try again.");
    } finally {
      setIsGenerating(false);
    }
  };

  const copyToClipboard = (text) => {
    const el = document.createElement('textarea');
    el.value = text;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
  };

  const filtered = resolutions.filter(r => filter === 'all' || r.type === filter);

  return (
    <div className="min-h-screen bg-slate-900 text-slate-100 font-sans selection:bg-indigo-500/30 overflow-x-hidden">
      {/* Background Blobs */}
      <div className="fixed inset-0 overflow-hidden pointer-events-none">
        <div className="absolute -top-24 -left-24 w-96 h-96 bg-indigo-600/20 rounded-full blur-[120px]" />
        <div className="absolute top-1/2 -right-24 w-80 h-80 bg-fuchsia-600/10 rounded-full blur-[100px]" />
        <div className="absolute -bottom-24 left-1/2 w-64 h-64 bg-blue-600/20 rounded-full blur-[80px]" />
      </div>

      <div className="relative z-10 max-w-6xl mx-auto px-4 py-8 md:py-12">
        {/* Header Section */}
        <header className="flex flex-col md:flex-row items-center justify-between gap-8 mb-12">
          <div className="text-center md:text-left">
            <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-indigo-500/10 border border-indigo-500/20 text-indigo-400 text-xs font-bold uppercase tracking-widest mb-4">
              <MapPin className="w-3 h-3" /> Dubuque, IA â€¢ 2026
            </div>
            <h1 className="text-5xl md:text-6xl font-black tracking-tighter bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400">
              TRACKER <span className="text-indigo-500">563</span>
            </h1>
          </div>

          <div className="grid grid-cols-2 md:grid-cols-3 gap-4 w-full md:w-auto">
            <StatCard icon={TrendingUp} label="Habits" value={stats.totalTicks} color="text-indigo-400" />
            <StatCard icon={Award} label="Goals" value={stats.total} color="text-fuchsia-400" />
            <button 
              onClick={generateShare}
              className="col-span-2 md:col-span-1 flex flex-col items-center justify-center p-4 rounded-3xl bg-white/5 border border-white/10 hover:bg-white/10 transition-all hover:scale-105 active:scale-95 group"
            >
              <Camera className="w-6 h-6 mb-1 text-emerald-400 group-hover:rotate-12 transition-transform" />
              <span className="text-[10px] font-black uppercase opacity-60">Share Story</span>
            </button>
          </div>
        </header>

        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
          {/* Input Sidebar */}
          <aside className="lg:col-span-4 space-y-6">
            <div className="bg-white/5 backdrop-blur-xl border border-white/10 p-8 rounded-[2.5rem] shadow-2xl">
              <h2 className="text-xl font-bold mb-6 flex items-center gap-2">
                <Sparkles className="w-5 h-5 text-amber-400" /> Create Goal
              </h2>
              <form onSubmit={addResolution} className="space-y-6">
                <div>
                  <input 
                    type="text" 
                    value={inputText}
                    onChange={(e) => { setInputText(e.target.value); setError(''); }}
                    placeholder="e.g. Hike Mines of Spain"
                    className={`w-full bg-slate-800/50 border-2 rounded-2xl px-5 py-4 outline-none transition-all placeholder:text-slate-600 font-medium ${error ? 'border-red-500/50 focus:border-red-500' : 'border-transparent focus:border-indigo-500/50'}`}
                  />
                  {error && <p className="text-red-400 text-xs font-bold mt-2 ml-2 flex items-center gap-1 italic"><AlertCircle className="w-3 h-3" /> {error}</p>}
                </div>

                <div className="grid grid-cols-3 gap-2">
                  {['daily', 'weekly', 'annual'].map(type => (
                    <button
                      key={type}
                      type="button"
                      onClick={() => setInputType(type)}
                      className={`py-3 rounded-xl text-[10px] font-black uppercase border-2 transition-all ${inputType === type ? 'bg-indigo-500/10 border-indigo-500 text-indigo-400' : 'bg-slate-800/50 border-transparent text-slate-500 hover:text-slate-300'}`}
                    >
                      {type}
                    </button>
                  ))}
                </div>

                <button type="submit" className="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-black py-4 rounded-2xl shadow-xl shadow-indigo-600/20 transition-all active:scale-95 flex items-center justify-center gap-2">
                  <Plus className="w-5 h-5" /> Add to List
                </button>
              </form>
            </div>

            <div className="bg-white/5 backdrop-blur-xl border border-white/10 p-6 rounded-[2rem]">
              <p className="text-[10px] font-black uppercase tracking-widest text-slate-500 mb-4">Focus View</p>
              <div className="flex flex-wrap gap-2">
                {['all', 'daily', 'weekly', 'annual'].map(f => (
                  <button 
                    key={f} 
                    onClick={() => setFilter(f)} 
                    className={`px-5 py-2 rounded-full text-[10px] font-black uppercase transition-all ${filter === f ? 'bg-indigo-500 text-white shadow-lg shadow-indigo-500/20' : 'bg-slate-800/50 text-slate-500 hover:text-slate-300'}`}
                  >
                    {f}
                  </button>
                ))}
              </div>
            </div>
          </aside>

          {/* Resolutions Feed */}
          <main className="lg:col-span-8 space-y-4">
            {filtered.length === 0 ? (
              <div className="flex flex-col items-center justify-center py-24 text-slate-600 border-2 border-dashed border-white/5 rounded-[3rem]">
                <Target className="w-16 h-16 mb-4 opacity-10" />
                <p className="font-bold tracking-tight uppercase">Ready for your first win?</p>
              </div>
            ) : (
              filtered.map((res) => (
                <ResolutionCard 
                  key={res.id} 
                  res={res} 
                  onAction={() => handleAction(res.id)} 
                  onDelete={() => deleteRes(res.id)} 
                />
              ))
            )}
          </main>
        </div>
      </div>

      {/* Share Modal */}
      {showShareModal && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-950/90 backdrop-blur-2xl">
          <div className="max-w-4xl w-full flex flex-col md:flex-row gap-8 items-center animate-in zoom-in-95 duration-300">
            {/* Story Card */}
            <div className="relative w-full max-w-[320px] aspect-[9/16] bg-slate-800 rounded-[2.5rem] overflow-hidden shadow-[0_0_80px_rgba(79,70,229,0.3)] border border-white/10">
              {isGenerating ? (
                <div className="absolute inset-0 flex flex-col items-center justify-center p-12 text-center gap-4">
                  <Loader2 className="w-12 h-12 animate-spin text-indigo-500" />
                  <p className="font-black text-xs uppercase tracking-[0.2em] text-indigo-200">Processing Progress...</p>
                </div>
              ) : (
                <>
                  <img src={shareImage} className="absolute inset-0 w-full h-full object-cover opacity-60" alt="Background" />
                  <div className="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent to-slate-900/50" />
                  <div className="relative z-10 h-full flex flex-col p-8 text-white">
                    <div className="flex justify-between items-start font-black text-[10px] uppercase tracking-widest opacity-40">
                      <span>{new Date().getFullYear()}</span>
                      <span>Dubuque, IA</span>
                    </div>
                    <div className="mt-auto mb-10 space-y-6">
                      <h2 className="text-4xl font-black leading-tight tracking-tighter">
                        KEY CITY<br/><span className="text-indigo-400">WINS.</span>
                      </h2>
                      <div className="grid grid-cols-2 gap-3">
                        <div className="bg-white/10 backdrop-blur-xl p-4 rounded-3xl border border-white/10">
                          <p className="text-[8px] font-black uppercase opacity-50 mb-1">Repetitions</p>
                          <p className="text-3xl font-black tracking-tight">{stats.totalTicks}</p>
                        </div>
                        <div className="bg-indigo-500/20 backdrop-blur-xl p-4 rounded-3xl border border-indigo-500/20">
                          <p className="text-[8px] font-black uppercase opacity-50 mb-1">Total Goals</p>
                          <p className="text-3xl font-black tracking-tight">{stats.total}</p>
                        </div>
                      </div>
                    </div>
                    <div className="text-[8px] text-center font-black uppercase tracking-[0.4em] opacity-30 mt-4">Tracker 563</div>
                  </div>
                </>
              )}
            </div>

            {/* Controls */}
            <div className="flex-1 max-w-sm space-y-8">
              <div>
                <h3 className="text-4xl font-black tracking-tighter mb-2 italic">Ready to Flex.</h3>
                <p className="text-slate-400 text-sm leading-relaxed">Screenshot the story and use the custom generated caption for your post.</p>
              </div>
              <div className="space-y-3">
                <div className="flex justify-between items-center text-[10px] font-black uppercase tracking-widest text-indigo-400 px-2">
                  <span>AI Caption</span>
                  <button onClick={() => copyToClipboard(shareCaption)} className="flex items-center gap-1.5 hover:text-white transition-colors">
                    <Copy className="w-3 h-3" /> Copy
                  </button>
                </div>
                <div className="bg-white/5 p-6 rounded-3xl border border-white/10 italic text-sm text-slate-300 leading-relaxed max-h-40 overflow-y-auto">
                  {shareCaption || "Thinking of something cool..."}
                </div>
              </div>
              <button onClick={() => setShowShareModal(false)} className="w-full bg-white text-black font-black py-4 rounded-2xl hover:bg-slate-200 transition-all flex items-center justify-center gap-2 active:scale-95 shadow-2xl">
                Close Preview
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Celebration Modal */}
      {celebration && (
        <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-slate-950/80 backdrop-blur-xl">
          <div className="bg-white rounded-[3rem] max-w-2xl w-full overflow-hidden shadow-2xl relative animate-in zoom-in-95 duration-300">
            <button onClick={() => setCelebration(null)} className="absolute top-8 right-8 p-3 rounded-full bg-black/5 hover:bg-black/10 transition-colors z-30">
              <X className="w-6 h-6 text-black" />
            </button>

            <div className="flex flex-col md:flex-row min-h-[400px]">
              <div className="md:w-5/12 h-64 md:h-auto overflow-hidden bg-slate-100 relative">
                {!imgLoaded && (
                  <div className="absolute inset-0 flex items-center justify-center">
                    <Loader2 className="w-8 h-8 animate-spin text-slate-300" />
                  </div>
                )}
                <img 
                  src={celebration.image} 
                  onLoad={() => setImgLoaded(true)}
                  className={`w-full h-full object-cover transition-all duration-1000 ${imgLoaded ? 'opacity-100 scale-100' : 'opacity-0 scale-110'}`} 
                  alt={celebration.name}
                  onError={(e) => { e.target.src="https://images.unsplash.com/photo-1490730141103-6ca27a9f0042?auto=format&fit=crop&q=80&w=800"; setImgLoaded(true); }}
                />
                <div className="absolute inset-0 bg-gradient-to-r from-transparent to-white/10 pointer-events-none" />
              </div>

              <div className="md:w-7/12 p-10 md:p-14 flex flex-col justify-center bg-white relative">
                <Quote className="absolute -top-4 -left-4 w-24 h-24 text-slate-50 fill-current" />
                <div className="relative z-10">
                  <p className="text-2xl font-serif italic text-slate-800 leading-snug mb-8">"{celebration.quote}"</p>
                  <div className="flex items-center gap-4">
                    <div className="h-px w-8 bg-indigo-500" />
                    <div>
                      <h4 className="font-black text-indigo-600 uppercase tracking-tighter text-xl leading-none">{celebration.name}</h4>
                      <p className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mt-1">{celebration.bio}</p>
                    </div>
                  </div>
                </div>
                <button 
                  onClick={() => setCelebration(null)} 
                  className="mt-12 w-full bg-slate-900 text-white font-black py-4 rounded-2xl hover:bg-black transition-all shadow-xl flex items-center justify-center gap-2 active:scale-95"
                >
                  <Flame className="w-5 h-5 text-orange-400" /> Get Back To It
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

const StatCard = ({ icon: Icon, label, value, color }) => (
  <div className="bg-white/5 backdrop-blur-xl border border-white/10 p-4 rounded-3xl min-w-[100px] flex flex-col items-center justify-center">
    <Icon className={`w-5 h-5 mb-1 ${color}`} />
    <span className="text-2xl font-black leading-none">{value}</span>
    <span className="text-[9px] font-black uppercase opacity-40 mt-1 tracking-widest">{label}</span>
  </div>
);

const ResolutionCard = ({ res, onAction, onDelete }) => (
  <div className="group relative bg-white/5 backdrop-blur-xl border border-white/10 p-8 rounded-[2.5rem] transition-all hover:bg-white/[0.08] hover:translate-x-1">
    {/* Type Indicator */}
    <div className={`absolute left-0 top-1/2 -translate-y-1/2 w-1.5 h-1/2 rounded-r-full ${res.type === 'daily' ? 'bg-orange-500' : res.type === 'weekly' ? 'bg-blue-500' : 'bg-emerald-500'}`} />
    
    <div className="flex items-center justify-between gap-6">
      <div className="flex-1">
        <div className="flex items-center gap-3 mb-2">
          <span className={`text-[9px] font-black uppercase px-2 py-0.5 rounded-md ${res.type === 'daily' ? 'bg-orange-500/10 text-orange-400' : res.type === 'weekly' ? 'bg-blue-500/10 text-blue-400' : 'bg-emerald-500/10 text-emerald-400'}`}>
            {res.type}
          </span>
          <span className="text-[9px] font-bold text-slate-500 uppercase tracking-widest">Added {new Date(res.createdAt).toLocaleDateString()}</span>
        </div>
        <h3 className={`text-2xl font-bold tracking-tight ${res.isCompleted ? 'line-through text-slate-600' : 'text-slate-100'}`}>
          {res.text}
        </h3>
        
        <div className="mt-4 flex items-center gap-4">
          {res.type !== 'annual' ? (
            <div className="flex items-baseline gap-1.5">
              <span className="text-4xl font-black text-white">{res.count || 0}</span>
              <span className="text-[10px] font-black text-slate-500 uppercase tracking-tighter">Completions</span>
            </div>
          ) : (
            <div className={`flex items-center gap-2 px-4 py-1.5 rounded-full text-[10px] font-black uppercase transition-all ${res.isCompleted ? 'bg-emerald-500/20 text-emerald-400' : 'bg-slate-800 text-slate-500'}`}>
              {res.isCompleted ? <Check className="w-3 h-3" /> : <Info className="w-3 h-3" />}
              {res.isCompleted ? 'Goal Hit' : 'Milestone Pending'}
            </div>
          )}
        </div>
      </div>

      <div className="flex flex-col gap-2">
        <button 
          onClick={onAction}
          className={`w-14 h-14 rounded-3xl flex items-center justify-center transition-all ${res.isCompleted ? 'bg-emerald-500 text-white' : 'bg-indigo-600 text-white hover:bg-indigo-500 shadow-xl shadow-indigo-600/20 active:scale-90'}`}
        >
          {res.type === 'annual' ? <CheckCircle2 className="w-7 h-7" /> : <Plus className="w-7 h-7" />}
        </button>
        <div className="opacity-0 group-hover:opacity-100 flex flex-col gap-2 transition-opacity">
          <button onClick={onDelete} className="w-14 h-14 rounded-3xl bg-white/5 text-slate-500 hover:bg-red-500/10 hover:text-red-400 flex items-center justify-center transition-all">
            <Trash2 className="w-5 h-5" />
          </button>
        </div>
      </div>
    </div>
  </div>
);

export default App;
